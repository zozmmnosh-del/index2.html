<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ù…ÙƒØªØ¨Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/app-info-parser/dist/app-info-parser.min.js"></script>

    <style>
        :root { --primary: #0d6efd; --bg: #f4f6f9; }
        body { background-color: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 50px; }
        
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); background: white; overflow: hidden; }
        
        /* ÙˆØ¶Ø¹ Ø§Ù„Ø±ÙØ¹ */
        .upload-zone { 
            border: 2px dashed #cbd5e1; border-radius: 15px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: 0.3s; position: relative;
        }
        .upload-zone:hover { border-color: var(--primary); background: #f8fbff; }
        
        /* ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
        .app-icon-lg { width: 100px; height: 100px; border-radius: 22px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); object-fit: cover; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-area { display: none; margin-top: 20px; }
        .progress { height: 25px; border-radius: 12px; }
        
        /* Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-area { display: none; background: #e0f2fe; border-radius: 15px; padding: 20px; margin-top: 20px; border: 1px solid #bae6fd; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container mt-5">
        
        <!-- ================= 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±ÙØ¹ (Ù„Ù„Ù…Ø±Ø³Ù„) ================= -->
        <div id="uploader-section" class="row justify-content-center">
            <div class="col-md-6">
                <div class="card card-custom p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-primary">ğŸš€ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
                        <p class="text-muted small">Ø§Ø®ØªØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ³ÙŠØªÙ… Ø±ÙØ¹Ù‡ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙˆØ±Ø§Ù‹</p>
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù -->
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <div id="drop-text">
                            <i class="fa-brands fa-android fa-3x text-success mb-3"></i>
                            <h5>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù APK</h5>
                            <p class="text-muted small m-0">Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".apk" hidden onchange="handleFileUpload(this)">

                    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
                    <div id="progress-container" class="progress-area">
                        <label class="mb-2 fw-bold text-primary">Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³Ø­Ø§Ø¨Ø©...</label>
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
                        </div>
                        <p class="text-center small text-muted mt-2">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ ÙŠØ¹ØªÙ…Ø¯ Ø°Ù„Ùƒ Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>
                    </div>

                    <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
                    <div id="result-box" class="result-area text-center">
                        <i class="fa-solid fa-check-circle text-success fa-2x mb-2"></i>
                        <h5 class="fw-bold">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</h5>
                        <p class="small text-muted">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠÙ‚ÙˆÙ… Ø£ÙŠ Ø´Ø®Øµ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
                        
                        <div class="input-group mt-3" dir="ltr">
                            <button class="btn btn-primary" onclick="copyShareLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                            <input type="text" id="finalLink" class="form-control text-center" readonly>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ================= 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) ================= -->
        <div id="downloader-section" class="row justify-content-center hidden">
            <div class="col-md-5">
                <div class="card card-custom p-4 text-center">
                    <img id="view-icon" src="https://cdn-icons-png.flaticon.com/512/732/732205.png" class="app-icon-lg mb-3">
                    <h2 id="view-name" class="fw-bold mb-1">...</h2>
                    <span class="badge bg-secondary mb-4">APK File</span>

                    <div class="alert alert-success d-flex align-items-center justify-content-center p-2">
                        <i class="fa-solid fa-shield-alt me-2"></i> Ø§Ù„Ø±Ø§Ø¨Ø· Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„
                    </div>

                    <a id="download-btn" href="#" class="btn btn-success btn-lg w-100 shadow py-3 fw-bold">
                        <i class="fa-solid fa-cloud-arrow-down"></i> ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±
                    </a>
                    
                    <button onclick="sharePage()" class="btn btn-outline-secondary w-100 mt-2 rounded-pill">
                        Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙØ­Ø©
                    </button>

                    <div class="mt-4">
                        <a href="?" class="text-decoration-none text-muted small">Ø±ÙØ¹ ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯</a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // === 1. ÙƒØ´Ù ÙˆØ¶Ø¹ Ø§Ù„ØµÙØ­Ø© (Ù‡Ù„ Ø£Ù†Ø§ Ø§Ù„Ø±Ø§ÙØ¹ Ø£Ù… Ø§Ù„Ù…Ø­Ù…Ù„ØŸ) ===
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 'name' Ùˆ 'link' Ø¥Ø°Ù† Ù‡Ø°Ø§ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            if (params.has('name') && params.has('link')) {
                document.getElementById('uploader-section').classList.add('hidden');
                document.getElementById('downloader-section').classList.remove('hidden');
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                document.getElementById('view-name').textContent = decodeURIComponent(params.get('name'));
                document.getElementById('download-btn').href = decodeURIComponent(params.get('link'));
                
                // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù‚ØµØ± Ø§Ù„Ø±Ø§Ø¨Ø·)
                // ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ± Ø±Ø§Ø¨Ø· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ùˆ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
            }
        };

        // === 2. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ===
        async function handleFileUpload(input) {
            if (input.files.length === 0) return;
            const file = input.files[0];

            // 1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ù…Ø­Ù„ÙŠØ§Ù‹
            let appName = file.name;
            try {
                const parser = new AppInfoParser(file);
                const info = await parser.parse();
                appName = (Array.isArray(info.application.label) ? info.application.label[0] : info.application.label) || file.name;
            } catch (e) { console.log("Parsing info skipped"); }

            // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('drop-text').style.display = 'none';
            document.getElementById('fileInput').disabled = true;

            // 3. Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ø®Ø§Ø±Ø¬ÙŠ (File.io)
            const formData = new FormData();
            formData.append('file', file);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… XMLHttpRequest Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            const xhr = new XMLHttpRequest();
            // Ù…Ù„Ø§Ø­Ø¸Ø©: file.io ÙŠØ­Ø°Ù Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ù…Ø¯Ø©. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù€ API Ø¢Ø®Ø± Ø¥Ø°Ø§ ØªÙˆÙØ±.
            xhr.open('POST', 'https://file.io', true);

            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = percentComplete + '%';
                    progressBar.innerText = percentComplete + '%';
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        generateShareLink(appName, response.link);
                    } else {
                        alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹. Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø´ØºÙˆÙ„Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                        resetUI();
                    }
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©.");
                    resetUI();
                }
            };

            xhr.onerror = function() {
                alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                resetUI();
            };

            xhr.send(formData);
        }

        // === 3. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ===
        function generateShareLink(name, directLink) {
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('result-box').style.display = 'block';

            // ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø·: Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const baseUrl = window.location.href.split('?')[0];
            // Ù†Ù‚ÙˆÙ… Ø¨ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙƒÙˆÙ† Ø¢Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
            const finalUrl = `${baseUrl}?name=${encodeURIComponent(name)}&link=${encodeURIComponent(directLink)}`;
            
            document.getElementById('finalLink').value = finalUrl;
        }

        // === 4. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===
        function copyShareLink() {
            const copyText = document.getElementById("finalLink");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„ØµØ¯ÙŠÙ‚Ùƒ Ø§Ù„Ø¢Ù†.");
        }

        function sharePage() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('view-name').textContent,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.");
            }
        }

        function resetUI() {
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('drop-text').style.display = 'block';
            document.getElementById('fileInput').disabled = false;
            document.getElementById('fileInput').value = '';
        }
    </script>
</body>
</html>